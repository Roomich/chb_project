pipeline {
    agent { label "jenkins-agent" }
    // agent any

    tools {
        terraform 'terraform'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        timestamps()
        ansiColor('xtrem')
    }

    environment {
        AWS_ACCESS_KEY_ID = credentials('accessKey')
        ASW_SECRET_ACCESS_KEY = credentials('secretKey')
        PROJECT_DIR = 'terraform/infrastructure'
    }

    stages {
        // stage ('Checkout SCM') {
        //     steps {
        //         checkout scmGit(branches: [[name: 'Buildapp']], extensions: [], userRemoteConfigs: [[credentialsId: 'github_ssh', url: 'git@github.com:Roomich/chb_project.git']])
        //     }
        // }

        stage('Terraform init') {
            steps {
                dir(PROJECT_DIR) {
                    sh "terraform init -var 'acces_key=${AWS_ACCESS_KEY_ID}' -var 'secret_key=${ASW_SECRET_ACCESS_KEY}'"
                }
            }
        }

        stage('Terraform validate') {
            steps {
                dir(PROJECT_DIR) {
                    sh "terraform validate"
                }
            }
        }

        stage('Terraform plan') {
            steps {
                dir(PROJECT_DIR) {
                    sh "terraform plan -var 'acces_key=${AWS_ACCESS_KEY_ID}' -var 'secret_key=${ASW_SECRET_ACCESS_KEY}' -out terraform.tfplan"
                    stash name: "terraform-plan", includes: "terraform.tfplan"
                }
            }
        }

        stage('Terraform apply') {
            steps {
                dir(PROJECT_DIR) {
                    unstash "terraform-plan"
                    sh "terraform apply terraform.tfplan" 
                    
                }
            }
        }
    }
}